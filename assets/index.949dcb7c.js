var g=Object.defineProperty,p=Object.defineProperties;var w=Object.getOwnPropertyDescriptors;var d=Object.getOwnPropertySymbols;var m=Object.prototype.hasOwnProperty,v=Object.prototype.propertyIsEnumerable;var f=(o,t,i)=>t in o?g(o,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):o[t]=i,x=(o,t)=>{for(var i in t||(t={}))m.call(t,i)&&f(o,i,t[i]);if(d)for(var i of d(t))v.call(t,i)&&f(o,i,t[i]);return o},u=(o,t)=>p(o,w(t));const H=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))e(s);new MutationObserver(s=>{for(const h of s)if(h.type==="childList")for(const n of h.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&e(n)}).observe(document,{childList:!0,subtree:!0});function i(s){const h={};return s.integrity&&(h.integrity=s.integrity),s.referrerpolicy&&(h.referrerPolicy=s.referrerpolicy),s.crossorigin==="use-credentials"?h.credentials="include":s.crossorigin==="anonymous"?h.credentials="omit":h.credentials="same-origin",h}function e(s){if(s.ep)return;s.ep=!0;const h=i(s);fetch(s.href,h)}};H();class k{constructor({ctx:t,start:i,end:e,color:s,width:h=1}){this.ctx=t,this.start=i,this.end=e,this.color=s,this.width=h}draw(){this.ctx.beginPath(),this.ctx.moveTo(this.start.x,this.start.y),this.ctx.lineTo(this.end.x,this.end.y),this.ctx.strokeStyle=this.color,this.ctx.lineWidth=this.width,this.ctx.stroke(),this.ctx.closePath()}}class l{constructor({ctx:t,x:i,y:e,width:s,height:h,color:n,hoverColor:r=null,isHover:a=!1,strokeColor:c=null}){this.ctx=t,this.x=i,this.y=e,this.width=s,this.height=h,this.color=n,this.hoverColor=r,this.isHover=a,this.strokeColor=c}draw(){this.ctx.save(),this.ctx.beginPath(),this.ctx.rect(this.x,this.y,this.width,this.height),this.ctx.fillStyle=this.isHover?this.hoverColor:this.color,this.ctx.fill(),this.strokeColor&&(this.ctx.strokeStyle=this.strokeColor,this.ctx.stroke()),this.ctx.closePath(),this.ctx.restore()}}class b{constructor({ctx:t,x:i,y:e,text:s,color:h,textAlign:n,textBaseline:r,fontFamily:a,fontSize:c}){this.ctx=t,this.x=i,this.y=e,this.text=s,this.color=h,this.textAlign=n,this.textBaseline=r,this.fontFamily=a,this.fontSize=c}draw(){this.ctx.beginPath(),this.ctx.font=`${this.fontSize}px ${this.fontFamily}`,this.ctx.textAlign=this.textAlign,this.ctx.textBaseline=this.textBaseline,this.ctx.fillStyle=this.color,this.ctx.fillText(this.text,this.x,this.y),this.ctx.closePath()}}class P extends l{constructor({ctx:t,x:i,y:e,width:s,height:h,color:n,hoverColor:r,isHover:a,key:c,onHitTile:y=()=>{}}){super({ctx:t,x:i,y:e,width:s,height:h,color:n,hoverColor:r,isHover:a});this.key=c,this.highlight=null,this.text==null,this.onHitTile=y,this.initText(),this.initHighlight(),this.listener()}draw(){super.draw(),this.text.draw(),this.isHover&&this.highlight.draw()}initText(){this.text=new b({ctx:this.ctx,x:this.x+this.width/2,y:this.y+this.height/2,text:this.key,color:"#fff",fontSize:24,fontFamily:"Arial",textAlign:"center",textBaseline:"middle"})}initHighlight(){const t={x:this.x,y:this.y-200,width:this.width,height:200-22},i=this.ctx.createLinearGradient(0,t.y,0,this.y);i.addColorStop(0,"transparent"),i.addColorStop(1,"#fff"),this.highlight=new l(u(x({},t),{ctx:this.ctx,color:i}))}listener(){window.addEventListener("keydown",this.keyDownHandler.bind(this)),window.addEventListener("keyup",this.keyUpHandler.bind(this))}keyDownHandler(t){!this.isValidKey(t.code)||(this.isHover=!0,this.onHitTile(this.key))}keyUpHandler(t){!this.isValidKey(t.code)||(this.isHover=!1)}isValidKey(t){return t===`Key${this.key}`}}class T extends l{constructor({ctx:t,x:i,y:e,width:s,height:h,color:n,strokeColor:r}){super({ctx:t,x:i,y:e,width:s,height:h,color:n,strokeColor:r})}}class E extends l{constructor({ctx:t,x:i,y:e,width:s,height:h,color:n,speed:r,hitAt:a,position:c}){super({ctx:t,x:i,y:e*-1,width:s,height:h,color:n});this.speed=r,this.hitAt=a,this.position=c,this.hitted=!1,this.passed=!1}draw(){super.draw()}update(t){this.draw(),this.y=this.hitAt+t*this.speed}}const S="/osu-mania/";class C{static async fetchSongMap(){return fetch(`${S}songs/1.unforgiving/map.json`).then(t=>t.json())}}class K{constructor({canvas:t,timeEl:i,scoreEl:e}){this.canvas=t,this.ctx=this.canvas.getContext("2d"),this.timeEl=i,this.scoreEl=e,this.song={},this.tiles=[],this.keys=[],this.lines=[],this.border=null,this.interval=null,this.fps=1e3/30,this.laneCount=4,this.pianoKeysPosition={width:this.canvas.width/this.laneCount,height:140},this.borderPosition={top:22,height:15},this.offsetHeight=this.canvas.height-this.pianoKeysPosition.height-this.borderPosition.height,this.keysMap=["D","F","J","K"],this.ms=0,this.start=Date.now(),this.score=0,this.speed=1,this.tolerance=50}async init(){this.song=await C.fetchSongMap(),this.initUI(),this.initTiles(),this.animate()}initUI(){this.initPianoKeys(),this.initLine(),this.initBorder()}initTiles(){this.song.hitObjects.forEach(t=>{const i=this.canvas.width/this.laneCount,e=-t.hitAt*this.speed+this.offsetHeight,s=new E({ctx:this.ctx,x:(t.position-1)*i,y:e,hitAt:e,position:t.position-1,speed:this.speed,width:this.canvas.width/this.laneCount,height:30,color:"#ffb930"});this.tiles.push(s)}),console.log(this.tiles)}initLine(){Array(this.laneCount+1).fill("").forEach((t,i)=>{const{width:e,height:s}=this.pianoKeysPosition;this.lines.push(new k({ctx:this.ctx,start:{x:i*e,y:0},end:{x:i*e,y:this.canvas.height-s-this.borderPosition.top},color:"#868686"}))})}initBorder(){const{height:t}=this.pianoKeysPosition;this.border=new T({ctx:this.ctx,x:0,y:this.canvas.height-t-this.borderPosition.top,width:this.canvas.width,height:this.borderPosition.height,color:"#363636",strokeColor:"#fff"})}initPianoKeys(){this.keysMap.forEach((t,i)=>{const{width:e,height:s}=this.pianoKeysPosition;this.keys.push(new P({height:s,key:t,ctx:this.ctx,x:i*e+2,y:this.canvas.height-s,width:e-4,color:"#ffb930",hoverColor:"#d69b27",onHitTile:this.hitTileHandler.bind(this)}))})}draw(){this.tiles.forEach(t=>!t.passed&&!t.hitted&&t.update(this.ms)),this.keys.forEach(t=>t.draw()),this.lines.forEach(t=>t.draw()),this.border.draw(),this.timeEl.innerHTML=(this.ms/1e3).toFixed(2),this.scoreEl.innerHTML=`${this.score.toFixed(2)}%`}hitTileHandler(t){this.tiles.forEach(i=>{this.isTileHitted(i,t)&&(i.hitted=!0,i.passed=!0)})}vanishTiles(){this.tiles.forEach(t=>{t.y>this.offsetHeight+this.tolerance&&!t.hitted&&!t.passed&&(t.passed=!0)})}animate(){if(this.isFinish){alert(`Your score: ${this.score.toFixed(2)}%`);return}this.ms=Date.now()-this.start,this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.draw(),this.vanishTiles(),this.calculateScore(),this.interval=setTimeout(this.animate.bind(this),this.fps)}isTileHitted(t,i){return t.y+this.tolerance>=this.offsetHeight&&t.y<=this.offsetHeight+this.tolerance&&!t.hitted&&!t.passed&&t.position===this.keysMap.indexOf(i)}calculateScore(){const t=this.tiles.filter(e=>e.hitted).length,i=this.tiles.filter(e=>e.passed).length;this.score=i?t/i*100:0}get isFinish(){return this.ms>=this.song.hitObjects[this.song.hitObjects.length-1].hitAt+1e3}}const L=document.querySelector("#canvas"),A=document.querySelector(".time-container span"),F=document.querySelector(".score-container span"),B=new K({canvas:L,timeEl:A,scoreEl:F});window.onload=async()=>await B.init();
