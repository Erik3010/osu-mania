var p=Object.defineProperty,g=Object.defineProperties;var m=Object.getOwnPropertyDescriptors;var d=Object.getOwnPropertySymbols;var w=Object.prototype.hasOwnProperty,v=Object.prototype.propertyIsEnumerable;var u=(o,t,i)=>t in o?p(o,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):o[t]=i,f=(o,t)=>{for(var i in t||(t={}))w.call(t,i)&&u(o,i,t[i]);if(d)for(var i of d(t))v.call(t,i)&&u(o,i,t[i]);return o},y=(o,t)=>g(o,m(t));const k=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))e(s);new MutationObserver(s=>{for(const h of s)if(h.type==="childList")for(const n of h.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&e(n)}).observe(document,{childList:!0,subtree:!0});function i(s){const h={};return s.integrity&&(h.integrity=s.integrity),s.referrerpolicy&&(h.referrerPolicy=s.referrerpolicy),s.crossorigin==="use-credentials"?h.credentials="include":s.crossorigin==="anonymous"?h.credentials="omit":h.credentials="same-origin",h}function e(s){if(s.ep)return;s.ep=!0;const h=i(s);fetch(s.href,h)}};k();class S{constructor({ctx:t,start:i,end:e,color:s,width:h=1}){this.ctx=t,this.start=i,this.end=e,this.color=s,this.width=h}draw(){this.ctx.beginPath(),this.ctx.moveTo(this.start.x,this.start.y),this.ctx.lineTo(this.end.x,this.end.y),this.ctx.strokeStyle=this.color,this.ctx.lineWidth=this.width,this.ctx.stroke(),this.ctx.closePath()}}class c{constructor({ctx:t,x:i,y:e,width:s,height:h,color:n,hoverColor:l=null,isHover:a=!1,strokeColor:r=null}){this.ctx=t,this.x=i,this.y=e,this.width=s,this.height=h,this.color=n,this.hoverColor=l,this.isHover=a,this.strokeColor=r}draw(){this.ctx.save(),this.ctx.beginPath(),this.ctx.rect(this.x,this.y,this.width,this.height),this.ctx.fillStyle=this.isHover?this.hoverColor:this.color,this.ctx.fill(),this.strokeColor&&(this.ctx.strokeStyle=this.strokeColor,this.ctx.stroke()),this.ctx.closePath(),this.ctx.restore()}}class C{constructor({ctx:t,x:i,y:e,text:s,color:h,textAlign:n,textBaseline:l,fontFamily:a,fontSize:r}){this.ctx=t,this.x=i,this.y=e,this.text=s,this.color=h,this.textAlign=n,this.textBaseline=l,this.fontFamily=a,this.fontSize=r}draw(){this.ctx.beginPath(),this.ctx.font=`${this.fontSize}px ${this.fontFamily}`,this.ctx.textAlign=this.textAlign,this.ctx.textBaseline=this.textBaseline,this.ctx.fillStyle=this.color,this.ctx.fillText(this.text,this.x,this.y),this.ctx.closePath()}}class b extends c{constructor({ctx:t,x:i,y:e,width:s,height:h,color:n,hoverColor:l,isHover:a,key:r,onHitTile:x=()=>{}}){super({ctx:t,x:i,y:e,width:s,height:h,color:n,hoverColor:l,isHover:a});this.key=r,this.highlight=null,this.text==null,this.onHitTile=x,this.initText(),this.initHighlight(),this.listener()}draw(){super.draw(),this.text.draw(),this.isHover&&this.highlight.draw()}initText(){this.text=new C({ctx:this.ctx,x:this.x+this.width/2,y:this.y+this.height/2,text:this.key,color:"#fff",fontSize:24,fontFamily:"Arial",textAlign:"center",textBaseline:"middle"})}initHighlight(){const t={x:this.x,y:this.y-200,width:this.width,height:200-22},i=this.ctx.createLinearGradient(0,t.y,0,this.y);i.addColorStop(0,"transparent"),i.addColorStop(1,"#fff"),this.highlight=new c(y(f({},t),{ctx:this.ctx,color:i}))}listener(){window.addEventListener("keydown",this.keyDownHandler.bind(this)),window.addEventListener("keyup",this.keyUpHandler.bind(this))}keyDownHandler(t){!this.isValidKey(t.code)||(this.isHover=!0,this.onHitTile(this.key))}keyUpHandler(t){!this.isValidKey(t.code)||(this.isHover=!1)}isValidKey(t){return t===`Key${this.key}`}}class L extends c{constructor({ctx:t,x:i,y:e,width:s,height:h,color:n,strokeColor:l}){super({ctx:t,x:i,y:e,width:s,height:h,color:n,strokeColor:l})}}class M extends c{constructor({ctx:t,x:i,y:e,width:s,height:h,color:n,speed:l,hitAt:a,position:r}){super({ctx:t,x:i,y:e*-1,width:s,height:h,color:n});this.speed=l,this.hitAt=a,this.position=r,this.hitted=!1,this.passed=!1}draw(){super.draw()}update(t){this.draw(),this.y=this.hitAt+t*this.speed}}const E="/osu-mania/";class H{static async fetchSongMap(){return fetch(`${E}songs/1.unforgiving/map.json`).then(t=>t.json())}}class P{constructor({canvas:t,timeEl:i,scoreEl:e}){this.canvas=t,this.ctx=this.canvas.getContext("2d"),this.timeEl=i,this.scoreEl=e,this.song={},this.tiles=[],this.keys=[],this.lines=[],this.border=null,this.interval=null,this.fps=1e3/30,this.laneCount=4,this.pianoKeysPosition={width:this.canvas.width/this.laneCount,height:140},this.borderPosition={top:22,height:15},this.offsetHeight=this.canvas.height-this.pianoKeysPosition.height-this.borderPosition.height,this.keysMap=["D","F","J","K"],this.ms=0,this.start=0,this.score=0,this.speed=1,this.tolerance=50}async init(t){const i={slow:.5,normal:1,hardcore:2};this.speed=i[t],this.start=Date.now(),this.song=await H.fetchSongMap(),this.initUI(),this.initTiles(),this.animate()}initUI(){this.initPianoKeys(),this.initLine(),this.initBorder()}initTiles(){this.song.hitObjects.forEach(t=>{const i=this.canvas.width/this.laneCount,e=-t.hitAt*this.speed+this.offsetHeight,s=new M({ctx:this.ctx,x:(t.position-1)*i,y:e,hitAt:e,position:t.position-1,speed:this.speed,width:this.canvas.width/this.laneCount,height:30,color:"#ffb930"});this.tiles.push(s)}),console.log(this.tiles)}initLine(){Array(this.laneCount+1).fill("").forEach((t,i)=>{const{width:e,height:s}=this.pianoKeysPosition;this.lines.push(new S({ctx:this.ctx,start:{x:i*e,y:0},end:{x:i*e,y:this.canvas.height-s-this.borderPosition.top},color:"#868686"}))})}initBorder(){const{height:t}=this.pianoKeysPosition;this.border=new L({ctx:this.ctx,x:0,y:this.canvas.height-t-this.borderPosition.top,width:this.canvas.width,height:this.borderPosition.height,color:"#363636",strokeColor:"#fff"})}initPianoKeys(){this.keysMap.forEach((t,i)=>{const{width:e,height:s}=this.pianoKeysPosition;this.keys.push(new b({height:s,key:t,ctx:this.ctx,x:i*e+2,y:this.canvas.height-s,width:e-4,color:"#ffb930",hoverColor:"#d69b27",onHitTile:this.hitTileHandler.bind(this)}))})}draw(){this.tiles.forEach(t=>!t.passed&&!t.hitted&&t.update(this.ms)),this.keys.forEach(t=>t.draw()),this.lines.forEach(t=>t.draw()),this.border.draw(),this.timeEl.innerHTML=(this.ms/1e3).toFixed(2),this.scoreEl.innerHTML=`${this.score.toFixed(2)}%`}hitTileHandler(t){this.tiles.forEach(i=>{this.isTileHitted(i,t)&&(i.hitted=!0,i.passed=!0)})}vanishTiles(){this.tiles.forEach(t=>{t.y>this.offsetHeight+this.tolerance&&!t.hitted&&!t.passed&&(t.passed=!0)})}animate(){if(this.isFinish){alert(`Your score: ${this.score.toFixed(2)}%`);return}this.ms=Date.now()-this.start,this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.draw(),this.vanishTiles(),this.calculateScore(),this.interval=setTimeout(this.animate.bind(this),this.fps)}isTileHitted(t,i){return t.y+this.tolerance>=this.offsetHeight&&t.y<=this.offsetHeight+this.tolerance&&!t.hitted&&!t.passed&&t.position===this.keysMap.indexOf(i)}calculateScore(){const t=this.tiles.filter(e=>e.hitted).length,i=this.tiles.filter(e=>e.passed).length;this.score=i?t/i*100:0}get isFinish(){return this.ms>=this.song.hitObjects[this.song.hitObjects.length-1].hitAt+1e3}}class T{constructor({modal:t,closeButton:i,initialValue:e,onCloseButtonClicked:s}){this.modal=t,this.closeButton=i,this.modalContent=this.modal.querySelector(".modal"),this.isShowModal=e,this.onCloseButtonClicked=s}init(){this.isShowModal?this.openModal():this.closeModal(),this.listener()}listener(){this.closeButton.addEventListener("click",()=>{this.isShowModal?this.closeModal():this.openModal()}),this.modalContent.addEventListener("animationend",()=>{this.modalContent.style.display=this.isShowModal?"block":"none",this.modal.style.display=this.isShowModal?"flex":"none",this.isShowModal||this.onCloseButtonClicked()})}closeModal(){this.isShowModal=!1,this.modalContent.classList.add("hide-modal"),this.modalContent.classList.remove("show-modal")}openModal(){this.isShowModal=!0,this.modal.style.display="flex",this.modalContent.classList.remove("hide-modal"),this.modalContent.classList.add("show-modal")}}class B{constructor({game:t}){var i;this.game=t,this.modal=null,this.speedLeveEls=[...document.querySelectorAll(".speed-mode input[type=radio]")],this.selectedLevel=(i=this.speedLeveEls.find(e=>e.checked))==null?void 0:i.value}async init(){this.initModal(),this.speedLeveEls.forEach(t=>{t.addEventListener("change",i=>{i.target.checked&&(this.selectedLevel=i.target.value,this.modal.onCloseButtonClicked=this.game.init.bind(this.game,this.selectedLevel))})})}initModal(){this.modal=new T({modal:document.querySelector("#start-modal"),closeButton:document.querySelector("#start-btn"),initialValue:!0,onCloseButtonClicked:this.game.init.bind(this.game,this.selectedLevel)}),this.modal.init()}}const K=document.querySelector("#canvas"),A=document.querySelector(".time-container span"),q=document.querySelector(".score-container span");document.querySelector("#start-btn");document.querySelector("#start-modal");const F=new P({canvas:K,timeEl:A,scoreEl:q}),O=new B({game:F});window.onload=async()=>await O.init();
